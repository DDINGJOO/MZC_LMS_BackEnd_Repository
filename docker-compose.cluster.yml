version: '3.8'

services:
  # Redis Cluster Node 1
  redis-cluster-node-1:
    image: redis:7-alpine
    container_name: lms-redis-cluster-1
    restart: unless-stopped
    ports:
      - "6379:6379"
      - "16379:16379"  # Cluster bus port
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --port 6379
    volumes:
      - redis-cluster-node-1-data:/data
    networks:
      - lms-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cluster Node 2
  redis-cluster-node-2:
    image: redis:7-alpine
    container_name: lms-redis-cluster-2
    restart: unless-stopped
    ports:
      - "6380:6380"
      - "16380:16380"  # Cluster bus port
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --port 6380
    volumes:
      - redis-cluster-node-2-data:/data
    networks:
      - lms-network
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6380", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cluster Node 3
  redis-cluster-node-3:
    image: redis:7-alpine
    container_name: lms-redis-cluster-3
    restart: unless-stopped
    ports:
      - "6381:6381"
      - "16381:16381"  # Cluster bus port
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --port 6381
    volumes:
      - redis-cluster-node-3-data:/data
    networks:
      - lms-network
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6381", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cluster 초기화
  redis-cluster-init:
    image: redis:7-alpine
    container_name: lms-redis-cluster-init
    depends_on:
      - redis-cluster-node-1
      - redis-cluster-node-2
      - redis-cluster-node-3
    networks:
      - lms-network
    command: >
      sh -c "
        sleep 5 &&
        redis-cli --cluster create
        redis-cluster-node-1:6379
        redis-cluster-node-2:6380
        redis-cluster-node-3:6381
        --cluster-replicas 0 --cluster-yes
      "
    restart: "no"

networks:
  lms-network:
    driver: bridge

volumes:
  redis-cluster-node-1-data:
  redis-cluster-node-2-data:
  redis-cluster-node-3-data:
